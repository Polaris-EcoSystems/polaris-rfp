AWSTemplateFormatVersion: '2010-09-09'
Description: 'Polaris unified deployment (root stack) using nested stacks: Frontend (Amplify) + Backend (App Runner)'

Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues: ['development', 'staging', 'production']

  RepositoryUrl:
    Type: String
    Default: 'https://github.com/umair2602/polaris-rfp.git'

  BranchName:
    Type: String
    Default: main

  # Frontend (Amplify)
  GitHubToken:
    Type: String
    NoEcho: true

  EnableCustomDomain:
    Type: String
    Default: 'true'
    AllowedValues: ['true', 'false']

  CustomDomainName:
    Type: String
    Default: 'polariseco.com'

  CustomDomainPrefix:
    Type: String
    Default: 'rfp'

  # Backend (App Runner)
  CodeStarConnectionArn:
    Type: String
    Default: 'arn:aws:apprunner:us-east-1:211125621822:connection/polaris-rfp/577729d32ae34e1380983e866e425016'

  FrontendBaseUrl:
    Type: String
    Description: Frontend base URL for backend CORS + OAuth (use custom domain URL when available)
    Default: 'https://rfp.polariseco.com'

  CanvaClientId:
    Type: String
    Default: ''

  CanvaClientSecret:
    Type: String
    NoEcho: true
    Default: ''

  CanvaRedirectUri:
    Type: String
    Default: ''

  CanvaTokenEncKey:
    Type: String
    NoEcho: true
    Default: ''

  # Data store (DynamoDB)
  DdbTableName:
    Type: String
    Default: ''

  JwtSecret:
    Type: String
    NoEcho: true
    Default: ''

  JwtExpire:
    Type: String
    Default: '24h'

Conditions:
  UseCustomDomain: !Equals [!Ref EnableCustomDomain, 'true']
  UseProvidedCanvaClientId: !Not [!Equals [!Ref CanvaClientId, '']]
  UseProvidedCanvaClientSecret: !Not [!Equals [!Ref CanvaClientSecret, '']]
  UseProvidedCanvaRedirectUri: !Not [!Equals [!Ref CanvaRedirectUri, '']]
  UseProvidedCanvaTokenEncKey: !Not [!Equals [!Ref CanvaTokenEncKey, '']]
  UseProvidedDdbTableName: !Not [!Equals [!Ref DdbTableName, '']]

Resources:
  PolarisDataTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !If
        - UseProvidedDdbTableName
        - !Ref DdbTableName
        - !Sub 'polaris-rfp-${Environment}'
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
        - AttributeName: gsi1pk
          AttributeType: S
        - AttributeName: gsi1sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: gsi1pk
              KeyType: HASH
            - AttributeName: gsi1sk
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  PolarisAssetsBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          # Clean up orphan uploads (uploads done before a member is saved)
          - Id: ExpireUnassignedTeamUploads
            Status: Enabled
            Prefix: team/unassigned/
            ExpirationInDays: 7
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - '*'
            AllowedMethods:
              - GET
              - PUT
              - HEAD
            AllowedHeaders:
              - '*'
            ExposedHeaders:
              - ETag
            MaxAge: 3000
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  # Shared App Runner instance role (requested: full DynamoDB + S3 perms)
  AppRunnerInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'polaris-apprunner-instance-${Environment}-${AWS::Region}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: tasks.apprunner.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess
        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
      Policies:
        - PolicyName: PolarisAssetsS3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: AssetsBucketList
                Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource:
                  - !GetAtt PolarisAssetsBucket.Arn
              - Sid: AssetsObjectRW
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:CopyObject
                Resource:
                  - !Sub '${PolarisAssetsBucket.Arn}/*'

  BackendStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: backend-apprunner.yml
      Parameters:
        RepositoryUrl: !Ref RepositoryUrl
        BranchName: !Ref BranchName
        Environment: !Ref Environment
        CodeStarConnectionArn: !Ref CodeStarConnectionArn
        FrontendBaseUrl: !Ref FrontendBaseUrl
        CanvaClientId: !If
          - UseProvidedCanvaClientId
          - !Ref CanvaClientId
          - '{{resolve:secretsmanager:polaris-rfp/canva:SecretString:CANVA_CLIENT_ID}}'
        CanvaClientSecret: !If
          - UseProvidedCanvaClientSecret
          - !Ref CanvaClientSecret
          - '{{resolve:secretsmanager:polaris-rfp/canva:SecretString:CANVA_CLIENT_SECRET}}'
        CanvaRedirectUri: !If
          - UseProvidedCanvaRedirectUri
          - !Ref CanvaRedirectUri
          - '{{resolve:secretsmanager:polaris-rfp/canva:SecretString:CANVA_REDIRECT_URI}}'
        CanvaTokenEncKey: !If
          - UseProvidedCanvaTokenEncKey
          - !Ref CanvaTokenEncKey
          - '{{resolve:secretsmanager:polaris-rfp/canva:SecretString:CANVA_TOKEN_ENC_KEY}}'
        DdbTableName: !Ref PolarisDataTable
        AssetsBucketName: !Ref PolarisAssetsBucket
        JwtSecret: !Ref JwtSecret
        JwtExpire: !Ref JwtExpire
        AppRunnerInstanceRoleArn: !GetAtt AppRunnerInstanceRole.Arn

  FrontendStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: frontend-amplify.yml
      Parameters:
        RepositoryUrl: !Ref RepositoryUrl
        BranchName: !Ref BranchName
        Environment: !Ref Environment
        GitHubToken: !Ref GitHubToken
        BackendUrl: !GetAtt BackendStack.Outputs.AppRunnerServiceUrl
        EnableCustomDomain: !Ref EnableCustomDomain
        CustomDomainName: !Ref CustomDomainName
        CustomDomainPrefix: !Ref CustomDomainPrefix

Outputs:
  DdbTableName:
    Description: DynamoDB table name
    Value: !Ref PolarisDataTable

  AssetsBucketName:
    Description: S3 bucket name for uploaded assets (team headshots, etc.)
    Value: !Ref PolarisAssetsBucket

  BackendUrl:
    Description: App Runner backend URL
    Value: !GetAtt BackendStack.Outputs.AppRunnerServiceUrl

  BackendArn:
    Description: App Runner backend ARN
    Value: !GetAtt BackendStack.Outputs.AppRunnerServiceArn

  AmplifyAppId:
    Description: Amplify App ID
    Value: !GetAtt FrontendStack.Outputs.AmplifyAppId

  AmplifyDefaultUrl:
    Description: Amplify default URL for this branch
    Value: !GetAtt FrontendStack.Outputs.AmplifyAppUrl

  FrontendCustomDomainUrl:
    Description: Custom domain URL (if enabled)
    Value: !If
      - UseCustomDomain
      - !Sub 'https://${CustomDomainPrefix}.${CustomDomainName}'
      - ''

  AppRunnerInstanceRoleArn:
    Description: IAM role ARN used by App Runner instances
    Value: !GetAtt AppRunnerInstanceRole.Arn
